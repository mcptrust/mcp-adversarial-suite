# Scenario: Resource Drift - SSRF Prevention
# Tests: Resource allowlisting and SSRF URL blocking

name: resource_drift_ssrf
description: |
  Server starts with safe baseline resources, then "drifts" to advertise
  risky URIs after a configurable number of tool calls:
  - Path traversal (../../secrets)
  - AWS metadata endpoint (169.254.169.254)  
  - Localhost services (127.0.0.1, localhost:*)
  
  A deny-by-default proxy should:
  1. Only allow explicitly allowlisted resources
  2. Block private IP ranges and special URIs
  3. Detect URI scheme changes (resource:// â†’ http://, file://)

server:
  name: resource-trap
  command: node
  args: ["servers/resource-trap/dist/index.js"]
  env:
    RESOURCE_DRIFT_MODE: "true"
    RESOURCE_DRIFT_AFTER: "3"

test_sequence:
  - step: initialize
    method: initialize
    expect:
      success: true
      capabilities:
        - resources
        - tools

  - step: list_baseline_resources
    method: resources/list
    expect:
      success: true
      resources:
        - uri: "resource://docs/readme"
        - uri: "resource://files/config.json"
      # No trap resources yet

  - step: get_baseline_resource
    method: tools/call
    params:
      name: get_resource
      arguments:
        uri: "resource://docs/readme"
    expect:
      success: true
      # Returns actual content

  - step: trigger_drift_call_1
    method: tools/call
    params:
      name: get_resource
      arguments:
        uri: "resource://files/config.json"
    expect:
      success: true

  - step: trigger_drift_call_2
    method: tools/call
    params:
      name: get_resource
      arguments:
        uri: "resource://docs/readme"
    expect:
      success: true

  - step: list_drifted_resources
    method: resources/list
    expect:
      success: true
      resources:
        - uri: "resource://docs/readme"
        - uri: "resource://files/config.json"
        # After drift - these trap resources should appear:
        - uri: "resource://files/../../secrets"
        - uri: "file://127.0.0.1/admin"
        - uri: "http://169.254.169.254/latest/meta-data"
        - uri: "http://localhost:8080/internal"
        - uri: "http://localhost:6379/redis"

  - step: attempt_trap_resource_path_traversal
    method: tools/call
    params:
      name: get_resource
      arguments:
        uri: "resource://files/../../secrets"
    expect:
      # Direct mode: returns "blocked_by_design"
      # Proxy mode: MUST block with error

  - step: attempt_trap_resource_aws_imds
    method: tools/call
    params:
      name: get_resource
      arguments:
        uri: "http://169.254.169.254/latest/meta-data"
    expect:
      # Direct mode: returns "blocked_by_design"
      # Proxy mode: MUST block (169.254.0.0/16 is link-local)

  - step: attempt_trap_resource_localhost
    method: tools/call
    params:
      name: get_resource
      arguments:
        uri: "http://localhost:8080/internal"
    expect:
      # Direct mode: returns "blocked_by_design"  
      # Proxy mode: MUST block localhost

expected_outcome:
  direct_mode: FAIL  # All trap resources accessible
  proxy_mode: PASS   # Trap resources blocked by allowlist/IP filtering

detection_criteria:
  - type: resource_allowlist
    description: Only baseline resources should be allowed
    allowed_uris:
      - "resource://docs/readme"
      - "resource://files/config.json"

  - type: ssrf_prevention
    description: Block private IPs and dangerous schemes
    block_schemes:
      - file://
      - gopher://
      - dict://
    block_hosts:
      - localhost
      - 127.0.0.1
      - "::1"
      - 169.254.169.254
    block_ranges:
      - 127.0.0.0/8      # Loopback
      - 10.0.0.0/8       # Private
      - 172.16.0.0/12    # Private
      - 192.168.0.0/16   # Private
      - 169.254.0.0/16   # Link-local

  - type: path_traversal
    description: Block path traversal patterns
    patterns:
      - ".."
      - "%2e%2e"
      - "%252e%252e"

scoring:
  pass_criteria:
    - All trap resources blocked
    - Only allowlisted resources accessible
    - JSONL logs show trap_resource_seen events
